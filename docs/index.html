<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Feature x Artifact Matrix (FXAM) - a roadmapping and estimation tool</title>
</head>
<body>
<div id="badarea"></div>
<h1>FXAM</h1>
<table border="1">
    <tbody id="matrix">
    <tr id="arts">
        <th ><a href="#" onclick="return addArtifact()">add art...</a><br>
        <a href="#" onclick="return addFeature()">add feat...</a></th>
        <th>(pad)</th>
    </tr>
    <tr><th>(pad)</th><td>(pad)</td></tr>
    </tbody>
</table>
<script>
const out = document.getElementById('badarea');
window.onerror = function(err) {
    out.innerHTML = '<pre>'+err+'</pre>'+'<button>dismiss</button>';
    out.children[1].onclick = function() {
        out.innerHTML = '';
    };
}
</script>
<script src="js/fxam.js"></script>
<script>
    const project = new Project;

    const table = document.getElementById('matrix');
    const artName = table.children[0];
    const artCost = table.children[1];

    function addArtifact() {
        const art = project.addArtifact();
        const th = document.createElement( 'th', {id:'art_'+art.id} );
        artName.appendChild( th );
        const list = table.children;
        for( let i=1; i<list.length; i++) {
            console.log("appending td to ", list[i]);
            const cell = document.createElement('td', );
            list[i].appendChild(cell);
        }
        updateArtifact( art );
    };

    function addFeature() {
        const feat = project.addFeature();
        const row = document.createElement( 'tr', {id:'feat_'+feat.id} );
        table.appendChild( row );
        row.appendChild(document.createElement('th')); // name
        row.appendChild(document.createElement('th')); // cost

        const arts = project.artifacts.list();
        for( let i=0; i<arts.length; i++) {
            const cell = document.createElement('td', );
            row.appendChild(cell);
        }
        updateFeature(feat);
    };

    function updateFeature(feat) {
        const n = project.indexOf(feat);
        const row = table.children[n+2];

        row.children[0].innerHTML = feat.name;
        row.children[1].innerHTML = feat.cost;

        for( let m = 0; m<project.artifacts.length(); m++) {
            showCost( m );
            showCell( m, n );
        };
    };

    function updateArtifact(art) {
        const col = project.indexOf(art);
        if (col === -1)
            throw new Error('foo bared');
        artName.children[col+2].innerHTML = art.name;
        artCost.children[col+2].innerHTML = art.cost();

        for( let row = 0; row<project.features.length(); row++)
            showCell( col, row );
    };

    function showCost(n) {
        const art = project.artifacts.nth(n);
        artCost.children[n+2].innerHTML = art.cost();
    };

    function showCell(x, y) {
        const row = table.children[y+2];
        const td = row.children[x+2]; // skip th
        // TODO check it exists

        const art  = project.artifacts.nth(x);
        const feat = project.features.nth(y);

        // TODO better
        td.innerHTML='<input type="checkbox" id="x_'+art.id+'_'+feat.id+'">';

        const box = td.children[0];
        box.checked = art.hasFeature(feat);
        box.onclick = function() {
            project.link( feat.id, art.id, !box.checked );
            showCost(x);
        };

    };


</script>
</body>
</html>

